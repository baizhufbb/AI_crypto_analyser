# AI 自主分析框架（两阶段模式）

> **核心原则**：基于项目脚本实际获取的数据，充分发挥AI的金融知识和数据分析能力，完成从市场分析到交易决策的完整流程。

---

## 📋 任务类型识别

AI 首先判断任务类型：

| 场景 | 用户指令示例 | 执行流程 |
|------|-------------|---------|
| **A: 单个标的** | "分析 BTCUSDT" / "看看 ETH" | 跳过快照 → 直接获取标的详细数据 |
| **B: 市场扫描** | "找找机会" / "扫描市场" | 快照 → 筛选候选 → 获取详细数据 |

---

## 阶段0：数据获取清单

### 0.1 市场快照数据（仅场景B）

- [ ] 运行 `fetch_snapshot.py` 获取快照
- [ ] 检查 `top_volume` / `top_gainers` / `top_losers`
- [ ] 从 `tickers` 中筛选候选标的（根据流动性、波动率、板块等条件）

### 0.2 标的详细数据（所有场景必做）

对每个标的，必须获取以下**所有周期**的数据：
- [ ] 1D（日线）
- [ ] 4H（4小时线）
- [ ] 1H（1小时线）
- [ ] 15m（15分钟线）
- [ ] 5m（5分钟线）

每个周期的JSON文件必须包含：
- [ ] `klines` 数组（至少200根，包含完整技术指标）
- [ ] `ticker_24hr`（24小时统计）
- [ ] `funding_rate`（资金费率）
- [ ] `open_interest`（持仓量）
- [ ] `current_price`（最新价格）
- [ ] `order_book`（订单簿深度）

### 0.3 技术指标快速提取（使用 `analyze_file.py`）

- [ ] 已运行 `analyze_file.py --json` 提取结构化指标
- [ ] 已检查 `summary` 中的所有信号
- [ ] 如需要，已运行 `--volatility` 获取波动率扩张分析

---

## 阶段1：深度市场分析（无预设规则）

### 目标
基于获取的所有数据，进行全面、深入、多维度的分析。**必须使用所有可用的数据字段和指标**。

### 必须分析的数据维度

#### 1. 裸K结构分析

对每个周期（1D/4H/1H/15m/5m），AI 需要遍历 klines 数组中的全部记录（或至少最近200根），系统性地分析价格结构与形态。

**必须分析的内容**：

##### 1.1 趋势结构分析（基于摆动高低点）

**遍历方法**：
- 从最近200根K线（或全部）中，识别**摆动高点（Swing High）**和**摆动低点（Swing Low）**
- 摆动高点：K线的高点高于前后N根K线的高点（N通常为2-3）
- 摆动低点：K线的低点低于前后N根K线的低点

**趋势判断**：
- **上升趋势**：摆动高点和摆动低点**连续抬升**
  - 统计连续抬升的高点数量（如：5个连续抬升的高点）
  - 统计连续抬升的低点数量
- **下降趋势**：摆动高点和摆动低点**连续下降**
  - 统计连续下降的高点数量
  - 统计连续下降的低点数量
- **震荡/无趋势**：高低点**混乱**，无明显方向
  - 高低点在区间内来回波动
  - 连续抬升/下降的点数 < 3

**输出要求**：
- 最近摆动高点：列出至少3个（如：0.942, 0.874, 0.855）
- 最近摆动低点：列出至少3个（如：0.673, 0.638, 0.580）
- 连续抬升/下降的高点数：X个
- 连续抬升/下降的低点数：X个
- 趋势方向：上升/下降/震荡（基于高低点判断）

##### 1.2 关键价格结构位识别

**必须识别的结构**：
- **前N个高点**（至少3档）：
  - 最近高点：0.942（1根K线前）
  - 次高点：0.874（3根K线前）
  - 第三高点：0.855（5根K线前）

- **前N个低点**（至少3档）：
  - 最近低点：0.673（2根K线前）
  - 次低点：0.638（4根K线前）
  - 第三低点：0.580（7根K线前）

- **盘整区间边界**：
  - 识别横盘震荡的区间（如：0.82-0.88）
  - 区间内密集成交的区域
  - 区间的上沿和下沿（多次触及的价位）

- **突破/跌破位**：
  - 最近突破的阻力位（如：突破0.85）
  - 最近跌破的支撑位（如：跌破0.78）
  - 突破/跌破的有效性（是否收回）

**输出要求**：
- 主要阻力：XXX（距离：X%，X根K线前，强度：强/中/弱）
- 次级阻力：XXX（距离：X%，X根K线前）
- 主要支撑：XXX（距离：X%，X根K线前，强度：强/中/弱）
- 次级支撑：XXX（距离：X%，X根K线前）
- 盘整区间：XXX-XXX（多次触及的区间）

##### 1.3 当前价格位置判断

**判断维度**：
- 当前价格在**趋势结构中的位置**：
  - 接近顶部（距离最近高点 < 2%）
  - 中部（在高点和低点之间）
  - 接近底部（距离最近低点 < 2%）

- 当前价格在**24h区间中的位置**：
  - 24h区间：0.673 - 0.942
  - 当前价：0.854
  - 位置：上沿/中上部/中部/中下部/下沿

**输出要求**：
- 价格：XXX
- 在结构中的位置：接近顶部/中部/底部
- 距24h高点：XXX（X%）
- 距24h低点：XXX（X%）
- 在24h区间中的位置：XX%（从低到高的百分比）

##### 1.4 裸K形态识别（最近30-50根K线）

**必须识别的形态**：

**A. 单根K线形态**（反转信号）：

1. **Pinbar（长影线）**：
   - **长上影线**（长上影流星线）：
     - 上影线长度 >= 实体的2倍
     - 下影线很短（< 实体的0.5倍）
     - 解读：上方抛压重，可能见顶
     - 示例：开盘0.687，最高0.942，收盘0.854（上影0.088，实体0.167）

   - **长下影线**（锤头线）：
     - 下影线长度 >= 实体的2倍
     - 上影线很短
     - 解读：下方支撑强，可能见底

   - **十字星**：
     - 实体很小（开盘 ≈ 收盘）
     - 上下影线较长
     - 解读：多空平衡，可能变盘

2. **吞没形态**：
   - **看涨吞没**：
     - 阳线实体完全包裹前一根阴线实体
     - 解读：多头反转信号

   - **看跌吞没**：
     - 阴线实体完全包裹前一根阳线实体
     - 解读：空头反转信号

3. **窗口缺口**：
   - 向上跳空缺口（当前K线最低点 > 前一根K线最高点）
   - 向下跳空缺口（当前K线最高点 < 前一根K线最低点）
   - 解读：强势信号，但可能回补

**B. 多根K线组合形态**：

1. **双顶/双底**：
   - 双顶：两个相近的高点，中间有回调
   - 双底：两个相近的低点，中间有反弹
   - 解读：强烈的反转信号

2. **头肩顶/头肩底**：
   - 头肩顶：三个高点，中间最高，两肩较低
   - 头肩底：三个低点，中间最低，两肩较高
   - 解读：强烈的反转信号

3. **三角形整理**：
   - 上升三角形：高点水平，低点抬升
   - 下降三角形：高点降低，低点水平
   - 对称三角形：高点降低，低点抬升
   - 解读：突破方向决定趋势

4. **旗形整理**：
   - 上升旗形：急涨后小幅回调
   - 下降旗形：急跌后小幅反弹
   - 解读：大概率继续原趋势

5. **楔形**：
   - 上升楔形：高点降低，低点抬升（看跌）
   - 下降楔形：高点降低，低点更低但幅度收窄（看涨）

**C. 成交量配合的形态**：

1. **放量突破/跌破**：
   - K线实体大 + 成交量放大（> 2倍平均）
   - 解读：真实突破，趋势可能延续

2. **缩量回调/反弹**：
   - 价格回调/反弹 + 成交量萎缩（< 0.5倍平均）
   - 解读：健康回调，趋势未改

3. **量价背离**：
   - 价格创新高但成交量不创新高
   - 价格创新低但成交量不创新低
   - 解读：动能衰竭，可能反转

**形态完成度判断**：
- 形态完成度：0-100%
  - 双顶：第二个高点形成 = 100%，颈线跌破 = 确认
  - 三角形：收缩至顶点附近 = 100%，突破 = 确认
  - 旗形：回调至38.2%-61.8%区间 = 完成，突破 = 确认

**输出要求**：
- 识别到的形态：XXX（完成度：XX%）
- 形态类型：反转/持续
- 可靠性：强/中/弱
- 确认条件：还需要XX才能确认

##### 1.5 裸K形态的实战解读

**关键原则**：
- **形态位置 > 形态本身**：
  - 同样的"长上影线"，在高位 = 见顶信号，在低位 = 试探信号
  - 双顶在关键阻力位 = 强烈信号，在半山腰 = 假信号

- **多周期共振**：
  - 1D出现长上影 + 4H出现长上影 + 1H出现长上影 = 强烈信号
  - 1D双顶 + 4H双顶 = 强烈反转信号

- **成交量配合**：
  - 形态 + 放量 = 可靠性高
  - 形态 + 缩量 = 可靠性低

**输出要求**：
- 当前最强的裸K信号：XXX
- 信号强度：强/中/弱
- 多周期一致性：一致/冲突
- 成交量配合：有/无

---

#### 2. 技术指标综合分析

在完成裸K结构分析后，结合技术指标进行定量确认与补充分析。

**趋势类指标**（每个周期都要分析）：

**SMA（简单移动平均）**：
- MA20 数值
- MA50 数值
- MA20 与 MA50 的关系（多头排列/空头排列/纠缠）
- 价格与 MA20 的距离（绝对值和百分比）
- 价格与 MA50 的距离（绝对值和百分比）
- MA20 与 MA50 的差值百分比
- MA20/MA50 的斜率方向（向上/向下/平缓）

**EMA（指数移动平均）**：
- EMA20 数值
- EMA50 数值
- 价格与 EMA20 的距离百分比
- 价格与 EMA50 的距离百分比
- EMA20 与 EMA50 的差值百分比

**VWAP（成交量加权平均价）**：
- VWAP 数值
- 价格与 VWAP 的距离百分比
- 价格在 VWAP 上方/下方的含义（日内强势/弱势）

**震荡类指标**：

**RSI(14)**：
- 当前数值
- 所在区间：<20 极度超卖 / 20-30 超卖 / 30-50 偏空 / 50-70 偏多 / 70-80 超买 / >80 极度超买
- RSI 背离检查（价格新高但RSI不创新高 / 价格新低但RSI不创新低）
- RSI 趋势（上升/下降/震荡）

**布林带(20,2)**：
- 上轨数值
- 下轨数值
- %B 指标数值（当前价在布林带中的位置：0-1）
- 布林带宽度百分比
- 布林带状态：squeeze（收缩，width%<5）/ normal（正常，5-15%）/ expansion（扩张，>15%）
- 价格相对于布林带的位置：接近上轨/中轨/下轨/突破外轨

**MACD**：
- DIF 数值
- DEA 数值
- Histogram（柱状图）数值
- MACD 偏向：bullish（DIF>DEA）/ bearish（DIF<DEA）/ neutral
- MACD 动能方向：柱状图扩张/收缩
- MACD 金叉/死叉（最近一次交叉及类型）
- MACD 背离检查

**波动率指标**：

**ATR(14)**：
- ATR 数值
- ATR% 数值（相对于价格的百分比）
- ATR% 历史分位数（最近20根/50根中的位置）
- 当前波动率状态：低（<1%）/ 中（1-3%）/ 高（3-5%）/ 极高（>5%）
- ATR% 趋势（扩张/收缩/稳定）

**标准差波动率(20)**：
- volatility_20 数值
- volatility_20_pct 数值

---

#### 3. 市场微观结构分析（必做）

**订单簿深度**（`order_book`）：
- 买盘前10档总量
- 卖盘前10档总量
- 订单簿失衡度 = (买盘 - 卖盘) / (买盘 + 卖盘)
- 解读：正数偏向买方，负数偏向卖方，绝对值>0.3 为明显失衡
- 买卖价差（bid-ask spread）
- 流动性评估：充足/一般/不足

**资金费率**（`funding_rate`）：
- 当前资金费率数值
- 资金费率方向：正数（多头付费）/ 负数（空头付费）
- 资金费率绝对值：<0.01% 正常 / 0.01-0.05% 偏高 / >0.05% 极端
- 市场情绪推断：正偏大表示多头过热，负偏大表示空头过热
- 下次资金费时间（`next_funding_time`）

**持仓量**（`open_interest`）：
- 当前持仓量数值
- 持仓量变化（如果有历史数据对比）
- 持仓量与价格的关系：
  - 持仓增 + 价格涨 = 多头主动增仓（看涨）
  - 持仓增 + 价格跌 = 空头主动增仓（看跌）
  - 持仓减 + 价格涨 = 空头止损（可能持续）
  - 持仓减 + 价格跌 = 多头止损（可能持续）

---

#### 4. 成交量分析（必做）

**成交量状态**：
- 当前成交量数值
- volume_ratio（相对于过去N根平均的倍数，从 `analyze_file.py` 的 signals 获取）
- 成交量状态分类：
  - extreme_spike（>3倍）
  - spike（>2倍）
  - elevated（>1.5倍）
  - normal（0.5-1.5倍）
  - low（<0.5倍）

**量价关系**：
- 价格涨 + 放量 = 健康上涨
- 价格涨 + 缩量 = 动能减弱
- 价格跌 + 放量 = 健康下跌
- 价格跌 + 缩量 = 动能减弱
- 量价背离（价格创新高但成交量不创新高 / 价格创新低但成交量不创新低）

---

#### 5. 24小时市场数据（必读）

**24h统计**（`ticker_24hr`）：
- 24h涨跌幅（`priceChangePercent`）
- 24h最高价（`highPrice`）
- 24h最低价（`lowPrice`）
- 24h开盘价（`openPrice`）
- 24h成交量（`volume`）
- 24h成交额（`quoteVolume`）
- 24h价格区间宽度百分比（`range24hPct` = (high - low) / open * 100）

**市场定位**（场景B可选）：
- 场景B：与 `top_gainers` / `top_losers` / `top_volume` 对比排名
- 场景A：跳过

---

#### 6. 波动率扩张信号分析（使用 `analyze_file.py --volatility`）

- [ ] 已运行波动率分析
- 当前波动率状态：low_volatility / normal / high_volatility
- 波动率分位数（当前在历史中的位置百分比）
- 波动率趋势：increasing / decreasing
- 检测到的信号列表：
  - volatility_trend_reversal（波动率趋势反转）
  - volatility_compression_breakout（波动率压缩后突破）
  - volume_expansion（成交量放大）
  - rsi_oversold / rsi_overbought（RSI极端）
  - price_breakout_ma20 / price_breakdown_ma20（价格突破MA20）
  - extreme_funding_rate（极端资金费率）
  - order_book_imbalance（订单簿失衡）
  - high_24h_volatility（24h高波动）
- 综合判断：high_probability / medium_probability / low_probability / no_signal

---

#### 7. 与BTC的相关性分析（如适用）

- 对比BTC的当前走势
- 判断该标的与BTC的相关性：高相关/中相关/低相关
- 如果BTC出现大幅波动，该标的可能如何反应

---

#### 8. 多周期信号分析（使用 `analyze_file.py` 的 signals）

对每个周期，检查以下自动生成的信号：

**趋势信号**（`trend`）：
- uptrend（上涨趋势）
- downtrend（下降趋势）
- uptrend_pullback（上涨回调）
- downtrend_rebound（下跌反弹）
- sideways（震荡）

**EMA趋势**（`ema_trend`）：同上分类

**VWAP位置**（`vwap_position`）：
- above_vwap（价格高于平均成本）
- below_vwap（价格低于平均成本）

**成交量状态**（`volume_status`）：
- extreme_spike / spike / elevated / normal / low

**布林带状态**（`boll_regime_20`）：
- squeeze（收缩，可能即将突破）
- normal（正常）
- expansion（扩张，高波动）

**布林带位置**（`boll_position_20`）：
- below_band / near_lower / middle / near_upper / above_band

**MACD偏向**（`macd_bias`）：
- bullish / bearish / neutral

**MACD动能**（`macd_momentum_side`）：
- bullish / bearish / neutral

**MACD交叉**（`macd_cross`）：
- bullish_cross（金叉）
- bearish_cross（死叉）

---

#### 9. 综合评分与机会判断

基于以上所有分析，给出：

**综合评分（0-100）**：
- 评分理由
- 支持因素（列出至少3个）
- 风险因素（列出至少3个）

**机会类型判断**：
- 当前最适合的交易类型：
  - 趋势跟随（顺势而为）
  - 震荡交易（区间高抛低吸）
  - 突破交易（突破后追入）
  - 反转交易（顶底反转）
- 判断理由（详细说明）

---

## 阶段1输出格式（必须按此模板）

```markdown
## 阶段1：深度市场分析报告

### 1. 裸K结构分析

#### 1D级别

**趋势判断（基于摆动高低点）**：
- 最近摆动高点：XXX, XXX, XXX（列出至少3个）
- 最近摆动低点：XXX, XXX, XXX（列出至少3个）
- 连续抬升/下降的高点数：X个
- 连续抬升/下降的低点数：X个
- **趋势方向**：上升/下降/震荡（基于高低点判断）

**关键结构位**：
- 主要阻力：XXX（距离：X%，X根K线前，强度：强/中/弱）
- 次级阻力：XXX（距离：X%，X根K线前，强度：强/中/弱）
- 主要支撑：XXX（距离：X%，X根K线前，强度：强/中/弱）
- 次级支撑：XXX（距离：X%，X根K线前，强度：强/中/弱）
- 盘整区间：XXX-XXX（多次触及的区间）

**当前价格位置**：
- 价格：XXX
- 在结构中的位置：接近顶部/中部/底部
- 距24h高点：XXX（X%）
- 距24h低点：XXX（X%）
- 在24h区间中的位置：XX%（从低到高）

**裸K形态识别（最近30-50根）**：
- 最强的裸K信号：XXX（完成度：XX%）
- 形态类型：反转/持续
- 单根K线形态：
  - Pinbar（长上影/长下影）：有/无（描述：XXX）
  - 吞没形态：有/无（描述：XXX）
  - 十字星：有/无（描述：XXX）
- 多根K线组合：
  - 双顶/双底：有/无（描述：XXX）
  - 头肩顶/头肩底：有/无（描述：XXX）
  - 三角形整理：有/无（描述：XXX）
  - 旗形整理：有/无（描述：XXX）
- 成交量配合：放量/缩量/背离（描述：XXX）
- 多周期一致性：一致/冲突（1D/4H/1H是否都有相同信号）
- 信号强度：强/中/弱

#### 4H级别
（同上格式）

#### 1H级别
（同上格式）

#### 15m级别
（同上格式）

#### 5m级别
（同上格式）

---

### 2. 技术指标综合分析

#### 2.1 趋势类指标

**1D级别**：
- MA20：XXX，MA50：XXX
- MA20 排列：多头/空头/纠缠（MA20 vs MA50：±X%）
- 价格 vs MA20：+X% / -X%（上方/下方）
- 价格 vs MA50：+X% / -X%（上方/下方）
- EMA20：XXX，EMA50：XXX
- 价格 vs EMA20：+X% / -X%
- VWAP：XXX
- 价格 vs VWAP：+X% / -X%（日内强势/弱势）

**4H级别**：
（同上）

**1H级别**：
（同上）

**15m级别**：
（同上）

**5m级别**：
（同上）

#### 2.2 震荡类指标

**RSI(14)**：
- 1D：XX（区间：XX-XX，状态：超买/超卖/中性）
- 4H：XX（...）
- 1H：XX（...）
- 15m：XX（...）
- 5m：XX（...）
- RSI背离：有/无（描述：XXX）

**布林带(20,2)**：
- 1H上轨：XXX，下轨：XXX，中轨：XXX
- %B：X.XX（位置：接近上轨/中轨/下轨）
- 布林带宽度：X.XX%
- 布林带状态：squeeze（收缩）/ normal（正常）/ expansion（扩张）
- 历史宽度对比：当前处于历史高/中/低分位

#### 2.3 MACD

**1H级别**：
- DIF：XXX，DEA：XXX
- Histogram：XXX（正向/负向，扩张/收缩）
- MACD偏向：bullish / bearish / neutral
- 最近交叉：bullish_cross / bearish_cross（X根K线前）
- MACD背离：有/无（描述：XXX）

（其他周期同上）

#### 2.4 波动率指标

**ATR(14)**：
- 1H ATR：XXX
- 1H ATR%：X.XX%
- 当前波动率状态：低（<1%）/ 中（1-3%）/ 高（3-5%）/ 极高（>5%）
- ATR%历史分位数：XX%（最近20根中的位置）
- 波动率趋势：扩张/收缩/稳定

**标准差波动率(20)**：
- volatility_20_pct：X.XX%

---

### 3. 市场微观结构分析

**订单簿**：
- 买盘前10档总量：XXX USDT
- 卖盘前10档总量：XXX USDT
- 订单簿失衡度：X.XX（偏向：买盘/卖盘/平衡）
- 流动性评估：充足/一般/不足

**资金费率**：
- 当前费率：X.XXXX%（正数/负数）
- 费率水平：正常/偏高/极端
- 市场情绪：多头过热/空头过热/中性
- 下次费率时间：XXX

**持仓量**：
- 当前持仓：XXX
- 持仓变化：+X% / -X%（如果有历史对比）
- 持仓与价格关系：多头增仓/空头增仓/多头减仓/空头减仓

---

### 4. 成交量分析

**当前成交量**：XXX
**volume_ratio**：X.XX（是过去平均的X倍）
**成交量状态**：extreme_spike / spike / elevated / normal / low

**量价关系**：
- 状态：价格涨+放量 / 价格涨+缩量 / 价格跌+放量 / 价格跌+缩量
- 解读：健康上涨/动能减弱/健康下跌/动能不足
- 量价背离：有/无（描述：XXX）

---

### 5. 24小时市场数据

**24h涨跌幅**：+X% / -X%
**24h最高**：XXX
**24h最低**：XXX
**24h开盘**：XXX
**24h区间宽度**：X.XX%

**市场定位**（场景B可选，场景A跳过）：
- 涨跌幅排名：涨幅榜第X / 跌幅榜第X / 中游
- 成交额排名：成交量榜第X / 中游
- 关注度：高/中/低

---

### 6. 波动率扩张信号分析

**波动率状态**：
- 当前regime：low_volatility / normal / high_volatility
- 波动率分位数：XX%（处于历史XX位置）
- 波动率趋势：increasing / decreasing

**检测到的信号**：
1. [信号类型]：[描述]（强度：X）
2. [信号类型]：[描述]（强度：X）
...

**综合判断**：
- 结论：high_probability / medium_probability / low_probability / no_signal
- 解释：[详细说明]

---

### 7. 与BTC的相关性

**BTC当前走势**：[描述]
**相关性评估**：高/中/低
**联动影响**：[如果BTC波动，该标的可能如何反应]

---

### 8. 多周期信号汇总

**1D**：trend=XXX, ema_trend=XXX, rsi_status=XXX, volume_status=XXX, macd_bias=XXX

**4H**：...

**1H**：...

**15m**：...

**5m**：...

**周期一致性**：
- 大周期（1D/4H）：一致/冲突
- 中小周期（1H/15m/5m）：一致/冲突
- 整体共振度：高/中/低

---

### 9. 综合评分与机会判断

**综合评分**：XX/100

**评分理由**：
- [列出评分依据，至少5条]

**支持因素**（至少3个）：
1. [因素1]：[详细说明]
2. [因素2]：[详细说明]
3. [因素3]：[详细说明]

**风险因素**（至少3个）：
1. [风险1]：[详细说明]
2. [风险2]：[详细说明]
3. [风险3]：[详细说明]

**机会类型判断**：
- 最适合：趋势跟随 / 震荡交易 / 突破交易 / 反转交易
- 理由：[详细说明]

**做多/做空倾向**：
- 倾向：做多/做空/观望
- 理由：[基于以上分析的综合判断，**必须明确引用裸K结构分析的结果**]
- 确定度：高（80%+）/ 中（60-80%）/ 低（<60%）
```

---

## 阶段2：综合决策与执行方案

### 目标
基于阶段1的完整分析，给出具体的、可执行的交易决策。

### 决策逻辑

**核心问题**：
1. 是否应该交易？（做多/做空/观望）
2. 如果交易，入场位置？
3. 止损位置？
4. 止盈目标？
5. 仓位大小？
6. 持仓时长？
7. 胜率和盈亏比？

### 基础风控规则（刚性约束）

无论分析结果如何，**必须遵守**：

1. **盈亏比要求**：
   - TP1必须达到至少1.5:1的盈亏比
   - 如果无法达到1.5:1，必须说明为什么值得入场，或者建议观望

2. **止损合理性**：
   - 止损必须在明确的技术结构位外侧（**优先使用裸K识别的前高/前低**，其次是MA50等指标位）
   - 必须考虑ATR预留合理的噪音空间（通常0.2-0.5×ATR）
   - 不使用"心理止损"

3. **仓位风险控制**：
   - 单笔交易的风险金额不超过总资金的2-3%
   - 如果波动率极高（ATR% > 5%），降低仓位

### 阶段2输出格式

```markdown
## 阶段2：执行方案

### 决策

**方向**：做多 / 做空 / 观望

**决策依据**：
- 裸K信号：XXX（如：1D长上影流星线 + 4H连续长上影）
- 关键结构位：XXX（如：在0.88-0.90阻力位区间）
- 趋势判断：XXX（基于高低点：上升/下降/震荡）
- 技术指标确认：[如：RSI超买、MACD金叉等]
- 成交量与市场微观结构：[如：放量突破、订单簿失衡等]

---

### 如果观望

**观望理由**：
- [基于阶段1分析，说明为什么不交易]

**触发条件**（什么条件下开始交易）：
1. [条件1]
2. [条件2]
3. [条件3]

---

### 如果做多/做空

#### 1. 入场计划

**方向**：做多 / 做空

**入场位置**：XXX（或区间 XXX-XXX）

**入场理由**：
- 裸K结构与形态：[具体说明，如：价格回调至0.77-0.775支撑位 + 出现长下影Pinbar]
- 关键结构位：[具体说明，如：前低XXX、盘整区间下沿XXX]
- 技术指标确认：[如：RSI从超卖回升至40+、MACD金叉]
- 多周期共振：[如：1D上升 + 4H回调 + 1H出现右侧信号]
- 成交量与市场微观结构：[如：放量突破、订单簿失衡等]
- 引用阶段1分析：[具体引用第X部分的分析]

**入场方式**：市价 / 限价（如果限价，说明具体价格）

**入场时机**：
- 立即 / 等待回调至XXX / 等待突破XXX
- 理由：[说明]

---

#### 2. 风险控制

**止损位置**：XXX

**止损依据**：
- 技术结构位：[具体说明，如前低XXX / 盘整区间下沿XXX / 关键支撑位XXX / MA50等]
- ATR缓冲：XXX（0.2-0.5×ATR14 = XXX）
- 为什么这个止损是合理的：[说明]

**风险金额计算**：
```
入场价：XXX
止损价：XXX
止损距离：X.XX%
账户资金：XXX USDT
风险金额：XXX USDT（X%）
```

---

#### 3. 止盈计划

**TP1**（必须）：XXX
- 技术位依据：[具体说明，如前高XXX、盘整区间上沿XXX、关键阻力位XXX]
- 盈亏比：1:X.XX
- 平仓比例：XX%（如30-50%）
- 预计达成时间：X-X小时/天

**TP2**（可选）：XXX
- 依据：[具体技术位]
- 盈亏比：1:X.XX
- 平仓比例：XX%
- 预计达成时间：X-X小时/天

**TP3**（可选，大级别目标）：XXX
- 依据：[具体技术位]
- 盈亏比：1:X.XX
- 平仓比例：XX%

---

#### 4. 仓位信息

**账户资金**：XXX USDT

**单笔风险金额**：XXX USDT（X%）

**杠杆**：XX倍（说明为什么选择这个杠杆）

**名义仓位**：XXX USDT

**计算过程**：
```
风险金额 = XXX USDT
止损距离 = X%
杠杆 = XX倍
名义仓位 = 风险金额 / (止损距离 × 杠杆)
          = XXX / (X% × XX)
          = XXX USDT
```

**仓位调整**（如适用）：
- 如果ATR% > 5%，仓位降低至XXX USDT
- 如果确定性极高，仓位可提升至XXX USDT

---

#### 5. 持仓管理

**预期持仓时长**：X-X小时/天

**观察要点**：
1. **价格观察位**：
   - 第一观察位：XXX（如果触及，考虑XXX）
   - 第二观察位：XXX（如果触及，考虑XXX）

2. **时间观察点**：
   - 首个观察点：X小时后（如果价格未推进，考虑XXX）
   - 第二观察点：X小时后（如果价格未推进，考虑XXX）

3. **提前离场条件**：
   - [条件1]：[描述]
   - [条件2]：[描述]
   - [条件3]：[描述]

**调整规则**：
- 如果价格达到TP1：
  - 平仓XX%
  - 剩余仓位止损移至：XXX（保本/微利）
- 如果价格长时间未推进：
  - 收紧止损至：XXX
  - 或减仓XX%
- 如果出现不利信号（如阶段1中的风险因素触发）：
  - 立即离场 / 减仓观望

---

#### 6. 概率评估

**胜率预估**：XX%

**依据**：
- 基于阶段1的综合评分：XX/100
- 裸K信号强度：强/中/弱
- 周期一致性：高/中/低
- 技术信号强度：强/中/弱
- 参考历史类似情况：[如果有，说明]

**盈亏比**：
- 风险：X%（止损距离）
- TP1收益：X%（盈亏比1:X.X）
- TP2收益：X%（盈亏比1:X.X）
- TP3收益：X%（盈亏比1:X.X）

**期望值**：
```
期望值 = (胜率 × TP1盈利 × TP1平仓比例) - (败率 × 止损亏损)
      = (XX% × X% × XX%) - (XX% × X%)
      = X.XX%
```

**风险收益评估**：
- 正期望值：是/否
- 是否值得交易：是/否（如果否，说明原因）

---

#### 7. 关键风险提示（必须列出至少3个）

1. **风险1**：[详细描述]
   - 触发条件：[什么情况下会发生]
   - 应对措施：[如何应对]

2. **风险2**：[详细描述]
   - 触发条件：[什么情况下会发生]
   - 应对措施：[如何应对]

3. **风险3**：[详细描述]
   - 触发条件：[什么情况下会发生]
   - 应对措施：[如何应对]

---

#### 8. 替代方案与应变计划

**如果当前方案失败**：

1. **价格触发止损后**：
   - 考虑：反向交易 / 观望 / 等待更好位置
   - 理由：[说明]

2. **价格长时间未推进（时间观察点触发）**：
   - 考虑：减仓XX% / 离场观望 / 调整止损至XXX
   - 理由：[说明]

3. **出现新的不利信号**：
   - 具体信号：[如BTC大幅下跌、该币利空等]
   - 应对：[提前离场/减仓/反向操作]

**其他可能的机会**：
- [如果当前方案不是最优，说明是否有更好的方向或时机]

---

### 执行清单

在最终执行前，确认：

- [ ] 已完成阶段1的所有分析维度
- [ ] 已遍历所有周期的K线数据（至少200根）
- [ ] 已完成裸K结构分析（摆动高低点、关键位、形态识别）
- [ ] 所有指标数据已读取和解读
- [ ] 止损位置有明确技术结构位依据（前高/前低/区间边界）
- [ ] 盈亏比≥1.5（或已说明例外理由）
- [ ] 仓位计算正确
- [ ] 风险金额在可承受范围内
- [ ] 已列出至少3个风险点
- [ ] 已制定应变计划

**最终确认**：本方案基于完整数据分析，可以执行 / 需要重新评估
```

---

## 质量控制自检清单

### 阶段1完成后自检

**裸K结构分析**：
- [ ] 是否分析了所有5个周期（1D/4H/1H/15m/5m）？
- [ ] 是否遍历了每个周期至少200根K线数据？
- [ ] 是否识别了摆动高低点（Swing High/Low）？
- [ ] 是否基于高低点判断趋势方向？
- [ ] 是否识别了至少3个支撑位和3个阻力位？
- [ ] 是否识别了裸K形态（Pinbar、吞没、双顶等）？
- [ ] 是否判断了形态完成度？
- [ ] 是否检查了多周期裸K信号的共振？

**技术指标分析**：
- [ ] 是否给出了所有技术指标的具体数值？
- [ ] 是否分析了订单簿、资金费率、持仓量？
- [ ] 是否分析了成交量和量价关系？
- [ ] 是否检查了波动率扩张信号？
- [ ] 是否评估了与BTC的相关性？
- [ ] 是否给出了综合评分？
- [ ] 是否列出了至少3个支持因素和3个风险因素？
- [ ] 是否判断了机会类型？

### 阶段2完成后自检

- [ ] 是否给出了明确的决策（做多/做空/观望）？
- [ ] 决策依据是否引用了阶段1的分析结果（裸K结构、技术指标、市场微观结构等）？
- [ ] 是否给出了具体的入场价格或区间？
- [ ] 止损位置是否有明确的技术结构位依据（前高/前低/关键支撑阻力位）？
- [ ] 是否给出了至少1档止盈目标？
- [ ] 盈亏比是否≥1.5？（如果不满足，是否说明了理由？）
- [ ] 是否给出了具体的仓位USDT数值？
- [ ] 是否计算了风险金额？
- [ ] 是否给出了预期持仓时长？
- [ ] 是否给出了胜率预估？
- [ ] 是否列出了至少3个风险点？
- [ ] 是否给出了替代方案和应变计划？

**如果任何一项为"否"，必须补充后再提交。**

---

## 附录：裸K分析快速参考

### 摆动高低点识别方法

**Swing High（摆动高点）**：
- 定义：K线的高点高于前N根和后N根K线的高点
- 通常N=2-3
- 用途：识别阻力位、判断上升趋势

**Swing Low（摆动低点）**：
- 定义：K线的低点低于前N根和后N根K线的低点
- 通常N=2-3
- 用途：识别支撑位、判断下降趋势

### 常见裸K形态速查

| 形态 | 特征 | 解读 | 可靠性 |
|------|------|------|--------|
| **长上影Pinbar** | 上影线 ≥ 实体2倍，下影线很短 | 上方抛压重，可能见顶 | 高位=强，低位=弱 |
| **长下影Pinbar** | 下影线 ≥ 实体2倍，上影线很短 | 下方支撑强，可能见底 | 低位=强，高位=弱 |
| **看涨吞没** | 阳线包裹前阴线 | 多头反转 | 中 |
| **看跌吞没** | 阴线包裹前阳线 | 空头反转 | 中 |
| **双顶** | 两个相近高点 | 强烈反转 | 强 |
| **双底** | 两个相近低点 | 强烈反转 | 强 |
| **上升三角形** | 高点水平，低点抬升 |大概率向上突破 | 中 |
| **下降三角形** | 高点降低，低点水平 |大概率向下突破 | 中 |

### 裸K分析优先级原则

```
1. 结构 > 形态 > 指标
   - 裸K结构位（前高前低） > 裸K形态（Pinbar等） > 技术指标（MA、RSI等）

2. 多周期共振 > 单周期信号
   - 1D+4H+1H同时出现信号 > 仅1H出现信号

3. 关键位置 > 任意位置
   - 在阻力/支撑位的形态 > 在中腰的形态

4. 成交量配合 > 无成交量
   - 放量突破 > 缩量突破
   - 放量反转 > 缩量反转
```

